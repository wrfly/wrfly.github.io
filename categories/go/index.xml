<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>go on wrfly&#39;s blog</title>
    <link>https://wrfly.kfd.me/categories/go/</link>
    <description>Recent content in go on wrfly&#39;s blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 25 Nov 2018 14:34:14 +0800</lastBuildDate>
    
	<atom:link href="https://wrfly.kfd.me/categories/go/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Golang-For-Loop</title>
      <link>https://wrfly.kfd.me/posts/golang-for-loop/</link>
      <pubDate>Sun, 25 Nov 2018 14:34:14 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/golang-for-loop/</guid>
      <description>ğŸ˜€
Recently my colleague meets a problem with golang for loop. He ranged an array of User, wanted to filter some user and append them (use pointer to get their address) to another user array, but finally got an array contains the same user.
Some thing like this:
newUsers := []*User{} for _, u := range UserArray{ if checkFailed(u){ continue } newUsers = append(newUsers, &amp;amp;u) } The newUsers got the same user with different indexes.</description>
    </item>
    
    <item>
      <title>Go-Tips-Token-Bucket</title>
      <link>https://wrfly.kfd.me/posts/go-tips-token-bucket/</link>
      <pubDate>Sat, 28 Jul 2018 23:29:49 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/go-tips-token-bucket/</guid>
      <description>å‰å‡ å¤©å†™äº†ä¸€ä¸ªdocker registryçš„lib https://github.com/wrfly/reglib
ç„¶ååœ¨å†™exampleçš„æ—¶å€™å‘ç°å¹¶å‘å¤ªé«˜, æŠŠregistryæå¾—502äº†, ç„¶åå°±æƒ³åŠæ³•æ€ä¹ˆé™åˆ¶ä¸€ä¸‹è¿™ä¸ªå¹¶å‘. å…¶å®è¿™ä¸ªé—®é¢˜åœ¨ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°è¿‡, å½“æ—¶å›ç­”çš„ä¸å¥½. å› ä¸ºä¸€èˆ¬çš„é™æµä»¤ç‰Œæ¡¶çš„è¯éƒ½æ˜¯æœ‰ä¸€ä¸ªæ—¶é—´å¾€é‡Œè¡¥å……çš„, æˆ‘å½“æ—¶è¿˜æ²¡æ¥è§¦è¿‡åˆ«çš„, æ‰€ä»¥å°±æ¯”è¾ƒå°´å°¬.
ä½†æ˜¯é‚£å¤©ä¸‹åˆå¿½ç„¶å°±æƒ³åˆ°å¯ä»¥ç”¨channelå»å®ç°è¿™ä¸ªä»¤ç‰Œæ¡¶, ä½†æ˜¯æ“ä½œæ°å¥½ç›¸å, æ“ä½œçš„æ—¶å€™ä¸æ˜¯å–å‡ºä»¤ç‰Œå†è¿›è¡Œä¸‹ä¸€æ­¥, è€Œæ˜¯å¾€é‡Œæ”¾, å¯¹åº”çš„, æ“ä½œå®Œæˆä¹Ÿä¸æ˜¯å†è¿˜å›ä»¤ç‰Œ, è€Œæ˜¯å–å‡º.
å¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­:
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;sync&amp;#34; &amp;#34;time&amp;#34; ) func main() { count := 15 limit := 5 var wg sync.WaitGroup wg.Add(count) tbChan := make(chan struct{}, limit) for index := 0; index &amp;lt; count; index++ { go func(index int) { tbChan &amp;lt;- struct{}{} defer func() { &amp;lt;-tbChan }() defer wg.Done() fmt.Printf(&amp;#34;this is %d\n&amp;#34;, index) time.</description>
    </item>
    
    <item>
      <title>What-is-a-Goroutine, seriously</title>
      <link>https://wrfly.kfd.me/posts/what-is-a-goroutine-seriously/</link>
      <pubDate>Mon, 02 Jul 2018 12:29:07 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/what-is-a-goroutine-seriously/</guid>
      <description>æ‹–å»¶äº†å¾ˆä¹…çš„ä¸€ç¯‡. å€Ÿé¢è¯•çš„æœºä¼š, æ¢³ç†ä¸€é.
 init and pstree åœ¨ç³»ç»Ÿä¸­, æ‰€æœ‰çš„æ‰§è¡Œå’Œæ“ä½œéƒ½æ˜¯é€šè¿‡è¿›ç¨‹å®ç°çš„. å½“æˆ‘ä»¬æŒ‰ä¸‹ç”µæºæŒ‰é’®çš„é‚£ä¸€åˆ», å°±ç›¸å½“äºç›˜å¤å¼€å¤©è¾Ÿåœ°äº†, ä»æ­¤, æ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼š&amp;rdquo;ä¾é™„äº&amp;rdquo;ä¸€ä¸ªå«initè¿›ç¨‹çš„ç‰¹æ®Šè¿›ç¨‹. å…³äºLinuxåˆå§‹åŒ–initè¿›ç¨‹, å¯ä»¥çœ‹ä¸‹è¿™ä¸€ä¸ªç³»åˆ—:
æµ…æ Linux åˆå§‹åŒ– init ç³»ç»Ÿ:
 Sysvinit UpStart Systemd  æˆ‘ä»¬å¯ä»¥é€šè¿‡ pstree æ¥æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³».
Process and Thread ä¸¥æ ¼æ„ä¹‰ä¸Šè®², å¹¶æ²¡æœ‰è¿›ç¨‹,çº¿ç¨‹çš„åŒºåˆ«, Linus åœ¨ä¸€ç¯‡é‚®ä»¶ä¸­è¡¨è¾¾äº†è‡ªå·±çš„è§‚ç‚¹: http://lkml.iu.edu/hypermail/linux/kernel/9608/0191.html
ä¸ç®¡æ˜¯Process,è¿˜æ˜¯Threads, éƒ½æ˜¯ä¸€äº›å¯è¢«æ‰§è¡Œçš„å®ä½“,context of execution (COE) or independent sequences of execution.
ä½†å¦‚æœè¯´åŒºåˆ«, è¿›ç¨‹ä¹‹é—´ä¸ä¼šå…±äº«å†…å­˜(ä¸€èˆ¬æ¥è®²), è€Œçº¿ç¨‹ä¹‹é—´åˆ™ä¼šå…±äº«è¿›ç¨‹çš„å†…å­˜. çº¿ç¨‹æ˜¯è¿›ç¨‹èµ„æºçš„å­é›†, ä»–ä»¬å”¯ä¸€çš„åŒºåˆ«åœ¨äºæ˜¯å¦å…±äº«äº†èµ„æº.
 That state includes things like CPU state (registers etc), MMU state (page mappings), permission state (uid, gid) and various &amp;ldquo;communication states&amp;rdquo; (open files, signal handlers etc).</description>
    </item>
    
    <item>
      <title>Golang-Maaaap</title>
      <link>https://wrfly.kfd.me/posts/golang-maaaap/</link>
      <pubDate>Thu, 07 Jun 2018 21:53:55 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/golang-maaaap/</guid>
      <description>ä¸‹å‘¨å‡ºå»ç©.
 ä»å¤‡å¿˜é‡Œç¿»å‡ºä¸€ä¸ªè¯é¢˜. ä¹Ÿæ˜¯æ›¾ç»é‡åˆ°çš„é—®é¢˜. åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹, å¸Œæœ›èƒ½ç»™ä»–äººå¸®åŠ©.
https://stackoverflow.com/questions/32751537/why-do-i-get-a-cannot-assign-error-when-setting-value-to-a-struct-as-a-value-i
https://stackoverflow.com/questions/17438253/access-struct-in-map-without-copying
Problem å…ˆæ¥çœ‹ä¸€æ®µå°ä»£ç :
package main import &amp;#34;fmt&amp;#34; type person struct { name string age int } func main() { m := map[int]person{} for i := 0; i &amp;lt; 5; i++ { m[i] = person{ name: fmt.Sprintf(&amp;#34;person:%d&amp;#34;, i), } } for i := 0; i &amp;lt; 5; i++ { m[i].age = i } for _, p := range m { fmt.Println(p.name, p.age) } } https://play.</description>
    </item>
    
    <item>
      <title>Go-Scheduler</title>
      <link>https://wrfly.kfd.me/posts/go-scheduler/</link>
      <pubDate>Thu, 22 Feb 2018 18:13:29 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/go-scheduler/</guid>
      <description>ç¿»è¯‘è‡ª: http://morsmachine.dk/go-scheduler
è™½ç„¶æ˜¯13å¹´çš„ä¸€ç¯‡æ–‡ç« , ä½†è¿˜æ˜¯å€¼å¾—ä¸€è¯»çš„.
ä»‹ç» Go 1.1ç‰ˆæœ¬ä¸€ä¸ªå¤§çš„æ”¹åŠ¨æ˜¯ç”±Dmitry Vyukovåšçš„æ–°çš„è°ƒåº¦å™¨. æ–°çš„è°ƒåº¦å™¨åœ¨æ€§èƒ½ä¸Šä¸ºgoç¨‹åºå¹¶è¡Œæä¾›äº†&amp;rdquo;æˆå‰§æ€§&amp;rdquo;çš„æå‡(æ€»ä¹‹æ˜¯å¾ˆç‰›), ç„¶åè‡ªå·±åˆæ²¡åˆ«çš„äº‹æƒ…åš, å°±æƒ³ç€å†™ä¸€å†™è¿™ä¸ªæ–°çš„è°ƒåº¦å™¨(æˆ–è€…è¯´æ€è·¯, æ–¹æ³•, æ¦‚å¿µ balabala).
è¿™ç¯‡æ–‡ç« ä¸­çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½åœ¨è¿™ä¸ªåŸå§‹æ–‡æ¡£ä¸­æå‡ºäº†, è¿™ä¸ªæ–‡æ¡£å†™çš„å¾ˆå…¨é¢, ä½†æ˜¯å¤ª&amp;rdquo;æŠ€æœ¯&amp;rdquo;äº†. (æˆ‘æ„Ÿè§‰ä¹Ÿå¤ªæŠ€æœ¯äº†, äº‘é‡Œé›¾é‡Œçš„, æ‰€ä»¥ä½œè€…åœ¨è¿™é‡Œæ‰“ç®—é€šä¿—çš„è®²ä¸€è®²)
å…³äºæ–°çš„è°ƒåº¦å™¨, ä½ éœ€è¦çŸ¥é“çš„éƒ½åœ¨é‚£ç¯‡åŸå§‹æ–‡æ¡£é‡Œ, ä½†æ˜¯è¿™ç¯‡æ–‡ç« æœ‰å›¾~ æ‰€ä»¥æ›´æ¸…æ™°ä¸€ç‚¹.
å¸¦æœ‰è°ƒåº¦å™¨çš„Goè¿è¡Œæ—¶(go runtime)éœ€è¦ä»€ä¹ˆ åœ¨æˆ‘ä»¬æ·±å…¥äº†è§£è°ƒåº¦å™¨ä¹‹å‰, æˆ‘ä»¬éœ€è¦ç†è§£ä¸ºä»€ä¹ˆå®ƒæ˜¯å¿…é¡»çš„. ä¸ºä»€ä¹ˆåœ¨æ“ä½œç³»ç»Ÿå¯ä»¥å¸®ä½ è°ƒåº¦çº¿ç¨‹çš„æ—¶å€™, ä½ ä»ç„¶éœ€è¦ä¸€ä¸ªç”¨æˆ·ç©ºé—´ä¸‹çš„è°ƒåº¦å™¨.
POSIXçº¿ç¨‹APIå¯¹äºç°å­˜çš„Unixè¿›ç¨‹æ¨¡å‹æ¥è¯´æ›´åƒæ˜¯ä¸€ä¸ªé€»è¾‘æ‰©å±•, äºæ­¤, å¯¹äºçº¿ç¨‹çš„æ§åˆ¶, æ›´æ¥è¿‘ä¸å¯¹è¿›ç¨‹çš„æ§åˆ¶. çº¿ç¨‹æ‹¥æœ‰å…¶è‡ªå·±çš„ä¿¡å·æ ‡å¿—ä½, å¯ä»¥è¢«CPUååŒåˆ†é…, å¯ä»¥è¢«æ”¾è¿›cgroupsä¸­ç®¡ç†, å¯ä»¥è¢«æŸ¥è¯¢å…¶æ‰€ç”¨çš„èµ„æºç­‰. è¿™äº›æ§ä»¶å¯¹äºgoç¨‹åºè°ƒåº¦goroutineæ¥è¯´, å¢åŠ äº†å¾ˆå¤šæ— è°“çš„åŠŸèƒ½å’Œå¼€é”€, å¹¶ä¸”å½“çº¿ç¨‹æ•°è¾¾åˆ°100,000æ—¶, å¼€é”€ä¼šè¿…é€Ÿå¢åŠ .
å¦ä¸€ä¸ªé—®é¢˜æ˜¯, åŸºäºGoçš„è¯­è¨€æ¨¡å‹, ç³»ç»Ÿä¸èƒ½åˆ›å»ºå¯è¢«é€šçŸ¥çš„è°ƒåº¦å†³å®š(informed scheduling decisions). æ¯”å¦‚, Goåœ¨åƒåœ¾å›æ”¶æ—¶, éœ€è¦è®©æ‰€æœ‰çº¿ç¨‹åœæ­¢, å¹¶ä¸”çº¿ç¨‹ä½¿ç”¨çš„å†…å­˜éœ€è¦è¿è´¯. è¿™å°±æ¶‰åŠåˆ°, ç­‰åˆ°æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹è¾¾åˆ°ä¸€ä¸ªèƒ½ä½¿å†…å­˜è¿è´¯çš„ç‚¹.
å½“ä½ æœ‰å¾ˆå¤šçº¿ç¨‹éœ€è¦è¢«è°ƒåº¦åˆ°ä¸€ä¸ªéšæœºçš„ç‚¹çš„æ—¶å€™, å”¯ä¸€çš„æœºä¼šæ˜¯ä½ è¦ç­‰åˆ°å¤§å¤šæ•°çº¿ç¨‹éƒ½è¾¾åˆ°æŸä¸ªå†…å­˜è¿è´¯çš„ç‚¹. å¯¹äºGoè°ƒåº¦å™¨æ¥è¯´, å®ƒçŸ¥é“å“ªé‡Œçš„å†…å­˜æ˜¯è¿ç»­çš„, æ‰€ä»¥å°±èƒ½ä½œå‡ºè¿™æ ·çš„å†³å®š. è¿™å°±æ„å‘³ç€, å½“gcçš„æ—¶å€™(stw), æˆ‘ä»¬åªéœ€è¦ç­‰å¾…é‚£äº›æ­£åœ¨è¢«CPUè¿è¡Œçš„çº¿ç¨‹å³å¯.
è§’è‰²ä¸€è§ˆ å¯¹äºçº¿ç¨‹æ¥è¯´, æœ‰ä¸‰ç§å¸¸è§çš„æ¨¡å‹. ä¸€ä¸ªæ˜¯ N:1, å³å¤šä¸ªç”¨æˆ·ç©ºé—´ä¸‹çš„çº¿ç¨‹è¿è¡Œåœ¨åŒä¸€ä¸ªCPUæ ¸å¿ƒä¸Š. è¿™ç§æ¨¡å‹çš„ä¼˜ç‚¹æ˜¯, å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹é—´å¿«é€Ÿçš„åˆ‡æ¢ä¸Šä¸‹æ–‡, ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾, æ— æ³•åˆ©ç”¨å¤šæ ¸ç³»ç»Ÿçš„ä¼˜ç‚¹.</description>
    </item>
    
    <item>
      <title>Discover-sync.Pool</title>
      <link>https://wrfly.kfd.me/posts/discover-sync.pool/</link>
      <pubDate>Tue, 20 Feb 2018 20:05:06 +0800</pubDate>
      
      <guid>https://wrfly.kfd.me/posts/discover-sync.pool/</guid>
      <description>å…¶å®å¾ˆä¹…ä¹‹å‰å°±ç”¨åˆ°äº†è¿™ä¸ªä¸œè¥¿ï¼Œèµ·å› æ˜¯collecterç¨‹åºå ç”¨å¤ªå¤šå†…å­˜äº†ï¼Œç„¶åå°±ç”¨sync.Poolå¤ç”¨é¢å¤–æ¶ˆè€—çš„ä¸€æ¬¡æ€§å†…å­˜ï¼Œé¿å…GCå‘¨æœŸå¤ªé•¿ä½¿å†…å­˜æ¥ä¸åŠé‡Šæ”¾è€Œå¯¼è‡´çš„OOMã€‚
https://golang.org/pkg/sync/#Pool
ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªæ± å­é‡Œæ”¾äº†ä¸€äº›â€œä¸œè¥¿â€ï¼Œè¿™äº›ä¸œè¥¿æ˜¯æŸç§ç‰¹æ®Šçš„ç±»å‹ï¼Œç”¨çš„æ—¶å€™éœ€è¦æŒ‡å®šã€‚
æ± å­ä¼šéšç€ä½ çš„å–ç”¨è€Œæ‰©å¼ ï¼Œæ¯”å¦‚è¯´ï¼Œæ± å­é‡Œé¢æ”¾äº†æ‰³æ‰‹ï¼ˆæ‰³æ‰‹æ± ï¼‰ï¼Œç°åœ¨æœ‰10ä¸ªå·¥äººä¾æ¬¡å–ç”¨ï¼Œå½“ç¬¬ä¸€ä¸ªäººå–çš„æ—¶å€™ï¼Œâ€œæ‰³æ‰‹æ± â€å‘ç°æ²¡æœ‰æ‰³æ‰‹ï¼Œokï¼Œnewä¸€ä¸ªå‡ºæ¥; å½“ç¬¬ä¸€ä¸ªå·¥äººç”¨å®Œäº†çš„æ—¶å€™ï¼ŒæŠŠæ‰³æ‰‹æ”¾å›æ‰³æ‰‹æ± ï¼Œç„¶åç¬¬äºŒä¸ªäººå–çš„æ—¶å€™ï¼Œæ‰³æ‰‹æ± å°±ç›´æ¥è¿”å›é‚£ä¸ªæ‰³æ‰‹å°±å¯ä»¥äº†ã€‚å—¯â€¦â€¦å¦‚æœç¬¬ä¸€ä¸ªå·¥äººæ²¡æœ‰å½’è¿˜å‘¢ï¼Œé‚£ä¹ˆæ‰³æ‰‹æ± å°±è¦é‡æ–°newä¸€ä¸ªæ‰³æ‰‹äº†ï¼Œä¹Ÿå°±æ˜¯è¿™ç§æƒ…å†µï¼š10ä¸ªå·¥äººåŒæ—¶å–ç”¨æ‰³æ‰‹ï¼Œé‚£ä¹ˆæ‰³æ‰‹æ± å°±å¾—new10ä¸ªæ–°çš„å‡ºæ¥äº†ã€‚
ä¸€ä¸ªæµ‹è¯•ï¼š
https://gist.github.com/wrfly/7de7f1e0c87860aa2f92dc6ed64cb75b
Makefileï¼š
.PHONY: build run test NAME := $(shell basename `pwd`) build: go build run: ./$(NAME) test: build run go tool pprof -lines $(NAME) mem.porf  ä¸Šé¢é‚£ä¸ªgistä¸­ï¼Œæœ‰å‡ ä¸ªæµ‹è¯•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼š
wg.Add(alloc) for i := 0; i &amp;lt; alloc; i++ { go func(num int) { // justMake() 	// bufPoolGet() 	bufPoolGetAndPut(num) // bufPoolSleepAndGetAndPut(num) 	wg.Done() }(i) } ä¹Ÿå°±æ˜¯æ‹¿äº†æ¥ç€æ”¾å›å»çš„æ—¶å€™ï¼Œç»“æœå¦‚ä¸‹ï¼š
âœ syncPool_mem_usage_test make run go build ./syncPool_mem_usage_test newmake: 4 reused: 9996 reused slice(maybe equal to newmake) len: 0 âœ syncPool_mem_usage_test  ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–°åˆ†é…äº†4ä¸ª1e6é•¿åº¦çš„[]byteï¼Œå…¶ä½™çš„éƒ½æ˜¯å¤ç”¨çš„ã€‚</description>
    </item>
    
  </channel>
</rss>